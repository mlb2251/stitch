<!-- # <img src="dream_egg.png" alt="egg of dreams" height="40" align="left"> DreamEgg -->

# Stitch

## Quickstart

Run `cargo run --release --bin=compress data/cogsci/nuts-bolts.json --max-arity=2 --iterations=3`

In around 10 seconds this should produce an output like

```

=======Compression Summary=======
Found 3 inventions
Cost Improvement: (3.92x better) 1919558 -> 489600
inv0 (1.78x wrt orig): utility: 836528 | final_cost: 1079238 | 1.78x | uses: 320 | body: [inv0 arity=2: (T (repeat (T l (M 1 0 -0.5 (/ 0.5 (tan (/ pi #0))))) #0 (M 1 (/ (* 2 pi) #0) 0 0)) (M #1 0 0 0))]
inv1 (2.84x wrt orig): utility: 399806 | final_cost: 676248 | 1.60x | uses: 190 | body: [inv1 arity=2: (repeat (T (T #0 (M 0.5 0 0 0)) (M 1 0 (* #1 (cos (/ pi 4))) (* #1 (sin (/ pi 4))))))]
inv2 (3.92x wrt orig): utility: 184830 | final_cost: 489600 | 1.38x | uses: 168 | body: [inv2 arity=1: (T (T c (M 2 0 0 0)) (M #0 0 0 0))]
Time: 9119ms
Wrote to "out/out.json"
```

Brief guide to reading this:

- `inv0` is the autogenerated name of the invention
- `(1.78x wrt orig)` means the resulting compressed programs using `inv0` were 1.78x smaller than the original programs
- `utility: 836528` this is a measure of how many much smaller the program got after rewriting it in terms of the new primitives (divide by 100 to get appx how  many fewer leaf nodes are in the rewritten program)
- `uses: 320` the invention was useful in 320 places in the set of programs
- Note that in these inventions `#i` is used for invention variables and `$i` for original program variables.

## Command line arguments

- `--max-arity=2` or `-a2` controls max arity of invention found (default is 2)
- `--iterations=10` or `-i10` controls how many iterations of compression to run. Each iteration produces one invention (which can build on the previous ones)
- `--threads=10` or `-t10` is a quick way to boost performance by multithreading (default is 1)

To see a full list of command line options run `cargo run --release --bin=compress -- --help`

## Disabling optimizations

`cargo run --release --bin=compress data/cogsci/nuts-bolts.json -i3 --no-opt-free-vars --no-opt-upper-bound --no-opt-single-use --no-opt-single-task --no-opt-force-multiuse`

## Python Bindings

Currently initial Python bindings are offered.
- Build the bindings by running `./gen_bindings.sh` (they will be added to `bindings/`)
  - Tell me or open an issue if this command doesn't work! It may vary by OS and the current command may be somewhat OSX-specific in the `rustc` flags used but that could be improved
- Add the `stitch/bindings/` folder to your `$PYTHONPATH`, for example by adding `export PYTHONPATH="$PYTHONPATH:path/to/stitch/bindings/"` to your  `~/.bashrc` or however you do it with your particular shell / venv. This will mean the `stitch.so` file is in your python path which will let you import it.
- Launch `python` and try to `import stitch`.
- As a simple example run the Python code `import stitch,json; result = json.loads(stitch.compression(["(a a a)", "(b b b)"], iterations=1, max_arity=2)); print("Result:", result)` and it should find the `(#0 #0 #0)` invention.
- There are a lot more keyword arguments available (full list in `examples/stitch.rs` which is where the bindings live since keeping things in `examples/` is a workaround for having a project generate a cdylib for Python bindings in addition to normal Rust/). Basically everything that you would find in  `cargo run --release --bin=compress -- --help` is included.

## Benchmarking

* `cargo bench` runs the benchmarks. Running it twice in a row (e.g. from different branches) will do a comparison

Comparing your feature before merging it:

```bash
git checkout main
cargo bench
git checkout feature
cargo bench
```

<!-- ```bash
git checkout main
cargo bench --bench=compress_bench -- --save-baseline=main
git checkout feature
cargo bench --bench=compress_bench -- --save-baseline=feature
cargo bench -- --load-baseline=feature --baseline=master
``` -->

Details:

- `--save-baseline=main` saves a named baseline (comparing against a past version of it if it exists, then overwriting it)
- `--load-baseline=feature` means *don't run any benchmarks* just load the file as if it's a result that you just produced
- `--baseline=master` overrides which benchmark we're going to compare against
- `--bench=compress_bench` avoids the "unrecognized option" error detailed [here](https://bheisler.github.io/criterion.rs/book/faq.html#cargo-bench-gives-unrecognized-option-errors-for-valid-command-line-options)

## Flamegraph

install if you havent: `cargo install flamegraph`
`cargo build --release && sudo cargo flamegraph --root --output=out/flamegraph.svg --bin=compress data/cogsci/nuts-bolts.json`

## Acknowledgement

This work is supported in part by the Defense Advanced Research Projects Agency (DARPA) under the program Symbiotic Design for Cyber Physical Systems (SDCPS) Contract FA8750-20-C-0542 (Systemic Generative Engineering). The views, opinions, and/or findings expressed are those of the author(s) and do not necessarily reflect the view of DARPA.
